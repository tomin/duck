var CMenu=cc.Sprite.extend({defaultScale:.8,hovered:false,boundingBox:null,onClickCallback:null,ctor:function(e){this._super();this.initWithTexture(e);this.setScale(this.defaultScale)},onClick:function(e){this.onClickCallback=e},handleTouches:function(e,t){this.hovered&&this.onClickCallback&&this.onClickCallback()},handleTouchesMoved:function(e,t){var n=e[0].getLocation();this.boundingBox||(this.boundingBox=this.getBoundingBox());if(cc.Rect.CCRectContainsPoint(this.boundingBox,n)){if(!this.hovered){this.hovered=true;this.runAction(cc.ScaleTo.create(.01,1))}}else if(this.hovered){this.hovered=false;this.runAction(cc.ScaleTo.create(.01,this.defaultScale))}},handleTouchesEnded:function(e,t){}});var id=function(e){return document.getElementById(e)};var GameLayer=cc.Layer.extend({birdSprite:null,isDraggingSling:false,birdStartPos:cc.p(260,345.5),slingRadius:{min:20,max:80},slingAngle:{min:cc.DEGREES_TO_RADIANS(250),max:cc.DEGREES_TO_RADIANS(295)},smokeDistance:16,menus:[],url:"http://tomin.github.com/duck/",lastSmoke:null,slingRubber1:null,slingRubber2:null,slingRubber3:null,getTexture:function(e,t){var n=typeof t!=="undefined"?t:"png";return cc.TextureCache.getInstance().addImage("sprites/"+e+"."+n)},addObject:function(e){var t=typeof e.imgtype==="undefined"?"png":e.imgtype,n=cc.Sprite.createWithTexture(this.getTexture(e.name,t));n.setAnchorPoint(e.anchor||cc.p(.5,.5));n.setScaleX(e.scaleX||e.scale||1);n.setScaleY(e.scaleY||e.scale||1);n.setRotation(e.rotation||0);n.setPosition(cc.p(e.x||0,e.y||0));e.shape&&b2.enablePhysicsFor({type:e.type,shape:e.shape,sprite:n,radius:e.radius,density:e.density,userData:e.userData});this.addChild(n,e.z||0);return n},init:function(){this._super();this.removeAllChildrenWithCleanup(true);this.setTouchEnabled(true);var e=cc.Director.getInstance(),t=this,n=e.getWinSize();b2.initWorld();var r=this.addObject({name:"bg",imgtype:"jpg",anchor:cc.p(0,0),z:-1});var i=this.addObject({name:"ground",scaleX:2.5,anchor:cc.p(0,0),type:"static",shape:"box",density:0});var s=this.addObject({name:"platform",y:30,scaleY:1,anchor:cc.p(0,0),type:"static",shape:"box",density:0});var o=this.addObject({name:"sling1",x:284.5,y:224.5,scale:.7,anchor:cc.p(1,0)});var u=this.addObject({name:"sling2",x:268.5,y:281.5,scale:.7,anchor:cc.p(1,0),z:3});var a=this.addObject({name:"wood1",x:840.5,y:71,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var f=this.addObject({name:"wood1",x:1017.5,y:71,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var l=this.addObject({name:"wood2",x:931.5,y:131.5,scaleX:1.3,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var c=this.addObject({name:"wood2",x:931.5,y:251.5,scaleX:1.3,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var h=this.addObject({name:"wood2",x:880,y:330,rotation:-40,scaleX:.8,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var p=this.addObject({name:"wood2",x:980,y:330,rotation:40,scaleX:.8,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var d=this.addObject({name:"wood1",x:840.5,y:200.5,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var v=this.addObject({name:"wood1",x:1017.5,y:200.5,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var m=this.addObject({name:"wood1",x:930,y:300,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Wood,2e3)});var g=this.addObject({name:"enemy",x:931.5,y:71,type:"dynamic",shape:"circle",density:2,userData:new BodyUserData(GameObjectRoll.Enemy,200)});var y=this.addObject({name:"enemy",x:931.5,y:180,type:"dynamic",shape:"circle",density:2,userData:new BodyUserData(GameObjectRoll.Enemy,200)});var b=this.addObject({name:"enemy",x:863,y:280,type:"dynamic",shape:"circle",scale:.5,density:3,userData:new BodyUserData(GameObjectRoll.Enemy,50)});var w=this.addObject({name:"enemy",x:986,y:280,scale:.5,type:"dynamic",shape:"circle",density:2,userData:new BodyUserData(GameObjectRoll.Enemy,50)});var E=this.getTexture("panda_right1"),S=this.getTexture("panda_right2"),x=this.getTexture("panda_left1"),T=this.getTexture("panda_left2");var N=this.addObject({name:"panda_right1",x:40,y:80,z:3});var C=function(){var e=42,t=e/2,n=t*2,r=e/n,i=1080,s=i/2,o=cc.MoveBy.create(t,cc.p(i,0)),u=cc.MoveBy.create(t,cc.p(-i,0)),a=[o,u];N.runAction(cc.Sequence.create(a));setTimeout(C,e*1e3);for(var f=0;f<=e*2;f++){var l=E;if(f<e){l=f%2==0?E:S}else{l=f%2==0?x:T}setTimeout(function(e){return function(){N.setTexture(e)}}(l),f*500)}};C();var k=this.addObject({name:"adboard",x:704.5,y:71,scale:.8,type:"dynamic",shape:"box",userData:new BodyUserData(GameObjectRoll.Enemy,115)});var L=this.addObject({name:"diamond",x:1084.5,y:480.5});this.fireScreenSprite=this.addObject({name:"fire2",x:600,y:-275,z:99});this.birdSprite=this.addObject({name:"bird",x:200,y:345,z:1});this.slingRubber1=this.addObject({name:"sling3",x:278,y:341,scaleY:.7,scaleX:0,anchor:cc.p(1,.5),z:0});this.slingRubber2=this.addObject({name:"sling3",x:250,y:345,scaleY:.7,scaleX:0,anchor:cc.p(1,.5),z:2});this.slingRubber3=null;var A=25,O=new CMenu(this.getTexture("menu_back"));O.setPosition(cc.p(A,n.height-A));O.onClick(function(){window.location.href=this.url});this.addChild(O);this.menus.push(O);var M=new CMenu(this.getTexture("menu_refresh"));M.setPosition(cc.p(70,n.height-A));M.onClick(function(){t.init();id("bill").style.display="none"});this.addChild(M);this.menus.push(M);var _=cc.LabelTTF.create("0","fantasy",20,cc.size(20,20),cc.TEXT_ALIGNMENT_LEFT);_.setPosition(cc.p(n.width-80,n.height-20));_.schedule(function(){var e=parseInt(_.getString());if(e<b2.getUserScore()){_.setString((e+1).toString())}});this.addChild(_);var D=cc.Spawn.create(cc.RotateBy.create(1.5,360),cc.JumpTo.create(1.5,this.birdStartPos,100,1));this.birdSprite.runAction(D);this.scheduleUpdate()},update:function(e){b2.simulate();var t=cc.Director.getInstance(),n=this,r=t.getWinSize();if(this.birdSprite.body){var i=this.birdSprite.body.GetUserData();if(!i||i.isContacted)return;var s=this.birdSprite.getPosition(),o=cc.pSub(s,this.lastSmoke&&this.lastSmoke.getPosition()||cc.p(0,0)),u=cc.pLength(o);if(u>=this.smokeDistance){this.lastSmoke=this.addObject({name:"smoke",x:s.x,y:s.y,scale:Math.random()>=.5?.8:.6})}if(s.x>400&&s.x<420){var a=this.addObject({name:"fire",x:580,y:196,z:3});var f=this.addObject({name:"fire",x:415,y:196,z:3})}if(typeof this.fireflag==="undefined"){this.fireflag=true;setTimeout(function(){n.onFBShow()},8e3)}}},onFBShow:function(){var e=new Date,t=(new Date).toDateString(),n=(new Date).toTimeString().substr(0,7),r=b2.getUserScore(),i=Math.floor(Math.random()*3+3),s=Math.floor(Math.random()*4),o=["北上25.6","北上23.3","南下15.5","南下18.2"],u=o[s],a=this;id("bill").style.display="block";id("date").innerHTML=t;id("time").innerHTML=n;id("time2").innerHTML=n;id("price").innerHTML=i;id("price2").innerHTML=i;id("road").innerHTML=u;id("road2").innerHTML=u;id("score").innerHTML=r;id("fb_share").onclick=this.onFBClick;id("fire").onclick=function(){a.onFire.call(a);return false};id("close").onclick=function(){id("bill").style.display="none";return false}},onFire:function(){var e=6,t=cc.MoveBy.create(e,cc.p(0,800)),n=[t];this.fireScreenSprite.runAction(cc.Sequence.create(n));id("bill").style.display="none";setTimeout(function(){id("container").style.display="none";id("retry").style.display="block"},(e-2)*1e3)},onFBClick:function(){var e=b2.getUserScore(),t="http://tomin.github.io/duck/",n=encodeURIComponent("神送我"+e+"顆鑽石！"),r=encodeURIComponent(t),i=encodeURIComponent("「燒毀！斷開魂結！斷開鎖鍊！」盡在可爆鴨！"),s=encodeURIComponent(t+"images/diamond"+e+".jpg"),o="http://www.facebook.com/sharer.php?s=100&p[title]="+n+"&p[summary]="+i+"&p[url]="+r+"&p[images][0]="+s;window.open(o,"sharer","toolbar=0,status=0,width=626,height=436");return false},onTouchesBegan:function(e,t){this.menus.forEach(function(n){n.handleTouches(e,t)});var n=e[0].getLocation(),r=cc.pSub(this.birdStartPos,n);if((this.isDraggingSling=cc.pLength(r)<this.slingRadius.max)&&!this.birdSprite.body&&!this.slingRubber3){this.slingRubber3=this.addObject({name:"sling3",x:n.x,y:n.y,scaleY:1.5,scaleX:2,anchor:cc.p(0,.5),z:1})}},onTouchesMoved:function(e,t){this.menus.forEach(function(n){n.handleTouchesMoved(e,t)});if(!this.isDraggingSling||this.birdSprite.body)return;var n=e[0].getLocation(),r=cc.pSub(n,this.birdStartPos),i=cc.pLength(r),s=cc.pToAngle(r);s=s<0?Math.PI*2+s:s;i=MathH.clamp(i,this.slingRadius.min,this.slingRadius.max);if(s<=this.slingAngle.max&&s>=this.slingAngle.min){i=this.slingRadius.min}this.birdSprite.setPosition(cc.pAdd(this.birdStartPos,cc.p(i*Math.cos(s),i*Math.sin(s))));var o=function(e,t,n,r){var i=e.getPosition(),s=cc.pSub(t,i),o=cc.pToAngle(s),u=cc.RADIANS_TO_DEGREES(o),a=cc.pLength(s)+(n||8);e.setRotation(-u);e.setScaleX(-(a/e.getContentSize().width));if(r){e.setScaleY(1.1-.7/this.slingRadius.max*a);this.slingRubber3.setRotation(-u);this.slingRubber3.setPosition(cc.pAdd(i,cc.p(a*Math.cos(o),a*Math.sin(o))))}}.bind(this);var u=this.birdSprite.getPosition();o(this.slingRubber2,u,13,true);o(this.slingRubber1,u,0);this.slingRubber1.setScaleY(this.slingRubber2.getScaleY())},onTouchesEnded:function(e,t){this.menus.forEach(function(n){n.handleTouchesEnded(e,t)});if(!this.birdSprite.body&&this.isDraggingSling){this.slingRubber1.setVisible(false);this.slingRubber2.setVisible(false);this.slingRubber3.setVisible(false);b2.enablePhysicsFor({type:"dynamic",shape:"circle",sprite:this.birdSprite,density:15,restitution:.4,userData:new BodyUserData(GameObjectRoll.Bird,250)});var n=cc.pSub(this.birdStartPos,this.birdSprite.getPosition()),r=cc.pMult(n,12),i=this.birdSprite.body.GetWorldCenter();this.birdSprite.body.ApplyImpulse(r,i);this.isDraggingSling=false}},onKeyUp:function(e){},onKeyDown:function(e){}});var GameScene=cc.Scene.extend({onEnter:function(){this._super();var e=new GameLayer;e.init();this.addChild(e)}})